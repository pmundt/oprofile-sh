LD=ld
CC=gcc

include arch/arch.mak

MODINSTALLDIR = @MODINSTALLDIR@/oprofile
INCLUDES = -I@KINC@/ -I@topdir@/ -I@topdir@/libutil/ -I@topdir@/libop/ -I@topdir@/arch
BASIC_KCFLAGS = $(ARCH_CFLAGS) -pipe -O2 -fno-strict-aliasing -Wall -Wstrict-prototypes -Wunused 
BASIC_KCFLAGS += $(INCLUDES) -D__KERNEL__ -DMODULE @BKCFLAGS@ @MODVERSIONS@
KCFLAGS = $(BASIC_KCFLAGS) @NO_MODULE_VERSION@

HEADERS=apic_up_compat.h compat.h compat22.h compat24.h op_cache.h op_dcache.h oprofile.h
SOURCES=compat.c op_init.c op_rtc.c op_util.c oprofile.c op_dname.c
OBJECTS=compat.o op_events_module.o op_init.o op_rtc.o op_util.o oprofile_c.o op_dname.o
TARGET=oprofile.o

.PHONY: install clean uninstall
 
all: $(TARGET)
	$(MAKE) -C arch

install: all
	-$(MKDIR_P) $(MODINSTALLDIR)
	cp oprofile.o $(MODINSTALLDIR)
	if test "@KVERS@" = "`uname -r`"; then depmod -a ; fi
 
uninstall:
	-rm -f $(MODINSTALLDIR)/oprofile.o
	-rmdir --ignore-fail-on-non-empty  $(MODINSTALLDIR)
	if test "@KVERS@" = "`uname -r`"; then depmod -a ; fi
 
clean:
	rm -rf $(TARGET) $(OBJECTS) .deps

arch/oprofile_arch.o:
	$(MAKE) -C arch

$(TARGET): $(OBJECTS) arch/oprofile_arch.o
	$(MAKE) -C arch
	$(LD) -r -o $@ $(OBJECTS) arch/oprofile_arch.o

op_init.o: op_init.c
	$(CC) $(BASIC_KCFLAGS) -c -o $@ $<
 
op_events_module.o: @topdir@/libop/op_events.c
	$(CC) $(KCFLAGS) -c -o $@ $<
 
%.o: %.c
	$(CC) $(KCFLAGS) -c -o $@ $<

%_c.o: %.c
	$(CC) $(KCFLAGS) -c -o $@ $<

MKDIR_P=mkdir -p

include ../make.deps

# FIXME would we remove this special rules by renaming the file ?
.deps/oprofile.c.d: oprofile.c
	@$(MKDIR_P) .deps
	@set -e; \
	$(CC) $(CPPFLAGS_DEPS) -MM $< | sed 's|\($*\)\.o[ :]*|\1.o oprofile_c.o $@ : |g' > $@; \
	[ -s $@ ] || rm -f $@ ;
