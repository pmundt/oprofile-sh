OPROFILE_DIR=@OPROFILE_DIR@
VERSION=@VERSION@
KVERS=@KVERS@
KSRC=@KSRC@
MODINSTALLDIR=@MODINSTALLDIR@
MKDIR_P=mkdir -p
 
EXTRA_CFLAGS=@EXTRA_CFLAGS@ -D__NO_VERSION__ \
	-I$(OPROFILE_DIR) -I$(OPROFILE_DIR)/libutil -I$(OPROFILE_DIR)/libop

# enable -Werror for non-release versions except for on 2.5 kernels
ifneq (,$(findstring cvs,$(VERSION)))
ifeq (,$(findstring 2.5,$(KVERS)))
EXTRA_CFLAGS += -Werror
endif
endif
 
O_TARGET := oprofile-module.o
 
obj-y := compat.o op_events_module.o op_init.o op_rtc.o op_util.o op_dname.o oprofile.o arch/arch.o
obj-m := $(O_TARGET)
O_OBJS := $(obj-y)
M_OBJS := $(O_TARGET)

.PHONY: install clean uninstall
 
all:
	$(MAKE) -C arch all
	(cd $(KSRC) && $(MAKE) SUBDIRS=$(OPROFILE_DIR)/module modules)

install: all
	-$(MKDIR_P) $(MODINSTALLDIR)
	cp oprofile-module.o $(MODINSTALLDIR)
	if test $(KVERS) = "`uname -r`"; then depmod -a ; fi
 
uninstall:
	-rm -f $(MODINSTALLDIR)/oprofile.o
	-rmdir --ignore-fail-on-non-empty  $(MODINSTALLDIR)
	if test "2.4.19-pre2-rmap12g" = "`uname -r`"; then depmod -a ; fi
 
clean:
	$(MAKE) -C arch clean
	rm -rf $(O_TARGET) $(obj-y) .deps .*.flags

op_events_module.o: $(OPROFILE_DIR)/libop/op_events.c
	$(CC) $(CFLAGS) $(EXTRA_CFLAGS) -c -o $@ $<
 
TOPDIR := $(KSRC)
CONFIG_SHELL := TOPDIR=$(KSRC) /bin/bash
include $(KSRC)/Rules.make

# FIXME: deps
