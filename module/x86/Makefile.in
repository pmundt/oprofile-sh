OPROFILE_DIR=@OPROFILE_DIR@
VERSION=@VERSION@
KVERS=@KVERS@
KSRC=@KSRC@

EXTRA_CFLAGS=@EXTRA_CFLAGS@ -D__NO_VERSION__ \
	-I$(OPROFILE_DIR)/ -I$(OPROFILE_DIR)/libutil -I$(OPROFILE_DIR)/libop -I$(OPROFILE_DIR)/module
 
# enable -Werror for non-release versions except for on 2.5 kernels
ifneq (,$(findstring cvs,$(VERSION)))
ifeq (,$(findstring 2.5,$(KVERS)))
EXTRA_CFLAGS += -Werror
endif
endif

O_TARGET := arch.o
 
obj-y := cpu_type.o op_apic.o op_fixmap.o op_nmi.o op_syscalls.o oprofile_nmi.o
obj-m := $(O_TARGET)
O_OBJS := $(obj-y)
M_OBJS := $(O_TARGET)

all:
	(cd $(KSRC) && $(MAKE) SUBDIRS=$(OPROFILE_DIR)/module/x86 modules)

clean:
	rm -rf $(O_TARGET) $(obj-y) .deps .*.flags
	 
# FIXME: why do we need an explicit rule ??? 
oprofile_nmi.o: oprofile_nmi.S
	$(CC) -D__ASSEMBLY__ -D__KERNEL__ -traditional -c -o $@ $<

TOPDIR := $(KSRC)
CONFIG_SHELL := TOPDIR=$(KSRC) /bin/bash
include $(KSRC)/Rules.make

# FIXME: dependencies 
