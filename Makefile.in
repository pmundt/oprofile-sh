OPROFILE_DIR=@OPROFILE_DIR@
KSRC=@KSRC@
KVERS=@KVERS@
MODINSTALLDIR=$(DESTDIR)@MODINSTALLDIR@/oprofile
MKDIR_P=mkdir -p

.PHONY: all install clean distclean maintainerclean uninstall tags

ifeq "@OPROFILE_25@" "yes"
DAEMON_VERSION=daemon
else
DAEMON_VERSION=dae
endif
 
# take care: order of sub-dir build is meaningful
PRE_MODULE_SUBDIRS=libutil libop
POST_MODULE_SUBDIRS=libutil++ libopt++ libop++ libdb $(DAEMON_VERSION) utils pp gui doc
USER_SUBDIRS=$(PRE_MODULE_SUBDIRS) $(POST_MODULE_SUBDIRS)
SUBDIRS=$(PRE_MODULE_SUBDIRS) module/arch module $(POST_MODULE_SUBDIRS)

all: pre_module kernel_module post_module
all.user: pre_module post_module

post_module:
	for i in $(POST_MODULE_SUBDIRS) ; \
	do \
		(cd $$i && $(MAKE)) || exit 1 ; \
	done

pre_module:
	for i in $(PRE_MODULE_SUBDIRS) ; \
	do \
		(cd $$i && $(MAKE)) || exit 1 ; \
	done

ifeq "@OPROFILE_25@" "no"
kernel_module: pre_module
	(cd $(KSRC) && $(MAKE) SUBDIRS=$(OPROFILE_DIR)/module/arch modules) || exit 1 ;
	(cd $(KSRC) && $(MAKE) SUBDIRS=$(OPROFILE_DIR)/module modules) || exit 1 ;

install.kernel: kernel_module
	-$(MKDIR_P) $(MODINSTALLDIR)
	cp module/oprofile-module.o $(MODINSTALLDIR)/oprofile.o
	if test $(KVERS) = "`uname -r`"; then depmod -a ; fi
else
kernel_module:
install.kernel:
endif

install: install.kernel install.user

install.user: pre_module post_module
	for i in $(USER_SUBDIRS) ; \
	do \
		(cd $$i && $(MAKE) install) || exit 1 ; \
	done

uninstall.user:
	for i in $(USER_SUBDIRS); \
	do \
		(cd $$i && $(MAKE) uninstall) || exit 1 ; \
	done
	@echo "Goodbye."

uninstall: uninstall.user
	rm -f $(MODINSTALLDIR)/oprofile.o
	@echo "Goodbye."

clean:
	for i in $(USER_SUBDIRS) ; \
	do \
		(cd $$i && $(MAKE) clean) || exit 1 ; \
	done
	rm -f module/*.o module/arch/*.o module/.*.o.cmd module/.*.o.flags module/arch/.*.o.cmd module/arch/.*.o.flags

maintainerclean: distclean
	rm -f configure aclocal.m4 config.h.in doc/oprofile.1

distclean: clean
	for i in $(SUBDIRS) ; \
	do \
		rm -f $$i/Makefile ; \
	done
	rm -f Makefile tags config.status config.log config.cache make.common version.h config.h module/arch

tags:
	ctags -R

# broken 
# dist check list:
# 1. change version to non-cvs and commit
# 2. make dist (with doopr) 
# 3. upload to sf
# 4. add release
# 5. close fixed bugs
# 6. send release email
# 7. update freshmeat
# 8. cvs tag RELEASE_0_0_8
# 9. update webpage release-notes/, index, download, srcdoc/
dist:
	mkdir tmpdist ; \
	cd tmpdist ; \
	cvs checkout oprofile ; \
	cd oprofile ; \
	(find -type d -name CVS | xargs rm -rf) ; \
	./autogen.sh ; \
	./configure --mandir=/usr/local/share/man ; \
	cp doc/Makefile doc/Makefile.tmp ; \
	make distclean ; \
	cd doc && make -f Makefile.tmp && rm -f Makefile.tmp && cd .. ; \
	cd .. ; \
	mv oprofile oprofile-@VERSION@ ; \
	tar cvfz ../oprofile-@VERSION@.tar.gz oprofile-@VERSION@ ; \
	rm -rf oprofile-@VERSION@ ; \
	cd ..  ; \
	rm -rf tmpdist \

