MOC=@MOC@
UIC=@UIC@

CXXFLAGS=-ansi -Wall -pedantic -W @CXXFLAGS@ @QT2_INCLUDES@

.PHONY: all clean install uninstall
.SUFFIXES:

ifeq "@have_qt2@" "yes"

INSTALL_LIST=oprof_report
all: $(INSTALL_LIST)

clean:
	$(MAKE) -C ui clean
	rm -rf *.o .deps *.moc.* $(INSTALL_LIST)

install: all
	-$(MKDIR_P) $(BINDIR)
	for f in $(INSTALL_LIST); do \
		cp $$f $(BINDIR)/$$f && chmod 755 $(BINDIR)/$$f; \
	done

uninstall:
	for f in $(INSTALL_LIST); do rm -f $(BINDIR)/$$f; done
	@echo "---------------------------------------------------------------"
	@echo "The uninstall target does not remove your ~/.oprofile directory"
	@echo "---------------------------------------------------------------"

# we need explicit dependencies and build rules here else after a make clean
# dependencies can not be regenerated. This also have the side effect to
# implicitly put dependencies to oprof_report on *all* ui files because if one
# ui is modified all ui files are modified.
OP_REPORT_UI_OBJS=ui/oprof_report.base.o ui/oprof_report.base.moc.o
OP_REPORT_OBJS=oprof_report.o oprof_report.moc.o oprof_report_main.o \
 oprofpp_view.o hotspot_view.o ../events/op_events.o \
 ../events/op_events_desc.o ../dae/opd_util.o ../util/string_manip.o \
 ../util/file_manip.o ../util/misc.o ../pp/oprofpp_util.o ../pp/opf_container.o ../pp/demangle_symbol.o

# We do not put $(OP_REPORT_UI_OBJS) as dependency of oprof_report (make don't
# know how to rebuild it at this point) but it works due to side effect between
# Makefile, dependency file and ui/oprof_report.base.h
oprof_report: $(OP_REPORT_OBJS)
	$(MAKE) -C ui
	$(CXX) $(CXXFLAGS) -o $@ $^ $(OP_REPORT_UI_OBJS) @QT2_LDFLAGS@ @QT2_LIBS@ ../libdb/libdb.a -lbfd -lpopt -liberty -ldl

# we need explicit dependencies and build rules here else after a make clean
# dependencies can not be regenerated. This also have the side effect to
# implicitly put dependencies to oprof_report on *all* ui files because if one
# ui is modified all ui files are modified.
ui/oprof_report.base.h: ui/oprof_report.base.ui
	$(MAKE) -C ui oprof_report.base.h
ui/oprof_report.base.moc.cpp: ui/oprof_report.base.h
	$(MAKE) -C ui oprof_report.base.h

oprof_report.moc.o: oprof_report.moc.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprof_report.o: oprof_report.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprof_report_main.o: oprof_report_main.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprofpp_view.o: oprofpp_view.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
hotspot_view.o: hotspot_view.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# generate qt moc code for subclass
oprof_report.moc.cpp: oprof_report.h ui/oprof_report.base.h
	$(MOC) -o oprof_report.moc.cpp oprof_report.h

# dependencies
ALL_SOURCES = oprof_report_main.cpp oprof_report.cpp oprof_report.moc.cpp oprofpp_view.cpp hotspot_view.cpp

include ../Rules.make

CPPFLAGS_DEPS += @QT2_INCLUDES@

else
all:
clean:
install:
uninstall:
endif
